# 메모리 관리

리눅스는 커널의 메모리 관리 시스템으로 시스템에 탑재된 메모리를 관리한다.
메모리는 각 프로세스가 사용하는 것은 물론이고 커널 자체도 메모리를 사용한다.

## 메모리 통계 정보
- total: 시스템에 탑재된 전체 메모리 용량
- free: 표기상 이용하지 않는 메모리
- buff/cache: 버퍼 캐시 또는 페이지 캐시가 이용하는 메모리. 시스템의 빈 메모리가 부족하면 커널이 해제한다.
- available: 실질적으로 사용 가능한 메모리이다. free 필드 값의 메모리가 부족하면 해제되는 커널 내의 메모리 영역 사이즈를 더한 값으로, 해제될 수 있는 메모리에는 버퍼 캐시나 페이지 캐시의 대부분 혹은 다른 커널 내의 메모리 일부가 포함된다.
available 메모리 영역이 부족해지면 Out of Memory 현상이 일어난다.
OOM 현상으로 인해 OOM Killer라는 기능이 존재하는데
이 기능은 적절한 프로세스를 임의로 선택해 강제 종료하여 메모리 영역을 해제시킨다.

## 단순한 메모리 할당

먼저 가상 메모리가 없는 단순한 경우와 가상 메모리가 없어서 생기는 문제점에 대해 설명하겠다.

커널이 프로세스에 메모리를 할당하는 일은 크게 두 가지 타이밍이 벌어진다.

1. 프로세스를 생성할 때
2. 프로세스를 생성한 뒤 추가로 동적 메모리를 할당할 때

2의 동작의 경우 프로세스가 생성된 뒤 추가로 메모리가 더 필요하면 프로세스는 커널에 메모리 확보용 시스템 콜을 호출해서 메모리 할당을 요청한다.
커널은 메모리 할당 요청을 받으면 필요한 사이즈를 빈 메모리 영역으로부터 잘라내 그 영역의 시작 주소값을 반환한다.

이러한 메모리 할당 방법에는 문제점들이 있다.

1. 메모리 단편화 (memory fragmentation)
2. 다른 용도의 메모리 접근 가능
3. 여러 프로세스를 다루기 곤란

### 메모리 단편화

프로세스가 생성된 뒤 메모리의 획득, 해제를 반복하면 메모리 단편화 문제가 발생한다.
큰 메모리를 한번에 할당할 떄 문제가 됨

- 프로그램은 메모리를 획득할 때마다 얻은 메모리가 몇 개의 영역에 나누어져 있는 지 확인해야 하므로 매우 불편하다
- 더 큰 용도의 메모리 할당에 문제가 생길 수 있다.


## 가상 메모리

가상 메모리는 간단하게 설명하면 시스템에 탑재된 메모리를 프로세스가 직접 접근하지 않고 가상 주소라는 주소를 사용하여 간접적으로 접근하도록 하는 방식이다.
프로세스에 보이는 메모리 주소를 '가상 주소', 시스템에 탑재된 메모리의 실제 주소를 '물리 주소'라고 부른다.
또한 주소에 따라서 접근 가능한 범위를 '가상 주소 공간'이라고 부른다.

### 페이지 테이블

가상 주소에서 물리 주소로 변환하는 과정은 커널 내부에 보관되어 있는 '페이지 테이블'이라는 표를 사용한다. 가상 메모리는 전체 메모리를 페이지라는 단위로 나눠서 관리하고 있어서 변환은 페이지 단위로 이루어진다.

페이지 테이블에서 한 페이지에 대한 데이터를 '페이지 테이블 엔트리'라고 부르며 이 페이지 테이블 엔트리에는 가상 주소와 물리 주소의 대응 정보가 들어있다.
페이지 사이즈는 CPU 아키텍쳐에 따라 다르다. 흔히 사용하는 x86_64 아키텍쳐의 페이지 사이즈는 4킬로바이트이다.

물리 메모리에 매핑되어 있지 않은 가상 메모리에 접근을 하게되면 CPU에는 '페이지 폴트'라는 인터럽트가 발생한다. 페이지 폴트에 의해 현재 실행 중인 명령이 중단되고 커널 내의 '페이지 폴트 핸들러'라는 인터럽트 핸들러가 동작한다. 커널은 프로세스로부터 메모리 접근이 잘못되었다는 내용을 페이지 폴트 핸들러에 알려준다. 그 뒤 'SIGSEGV' 시그널을 프로세스에 통지한다. 이 시그널을 받은 프로세스는 강제로 종료된다.

## 프로세스에 메모리를 할당할 때

커널이 프로세스를 생성할 때나 추가로 메모리를 요청받을 때, 가상 메모리를 통하여 어떻게 프로세스에 메모리를 할당하고 있는 지 살펴본다.

프로그램을 실행하는데 필요한 메모리 사이즈는 '코드 영역 사이즈 + 데이터 영역 사이즈'이다.
리눅스에서 실제 물리 메모리 할당은 '디맨드 페이징'이라는 방식을 사용한다.

## 가상 메모리 응용

- 파일 맵
- 디맨드 페이징
- Copy on Write 방식의 고속 프로세스 생성
- 스왑(Swap)
- 계층형 페이지 테이블
- Hupe page

