# 사용자 모드로 구현되는 기능

사용자 모드는 라이브러리 형태인 것도 있고 단독 프로그램으로 동작하는 것도 있다.

## 시스템 콜
- 프로세스는 프로세스의 생성이나 하드웨어의 조작 등 커널의 도움이 필요할 경우 시스템 콜을 통해 커널에 처리를 요청합니다.

### 시스템 콜의 종류
- 프로세스 생성, 삭제
- 메모리 확보, 해제
- 프로세스 간 통신 (IPC)
- 네트워크
- 파일시스템 다루기
- 파일 다루기 (디바이스 접근)

### CPU의 모드 변경
- 시스템 콜은 CPU의 특수한 명령을 실행해야만 호출된다. 프로세스는 보통 사용자 모드로 실행되고 있지만 커널에 처리를 요청하고자 시스템 콜을 호출하면 CPU에서는 인터럽트 이벤트가 발생한다.
- 인터럽트 이벤트가 발생하면 CPU는 사용자 모드에서 커널 모드로 변경되며 요청한 내용을 처리하기 위해 커널이 동작하기 시작한다.
- 요청한 내용 처리가 끝나면 커널 내의 시스템 콜 처리가 종료된다. 그리고 다시 사용자 모드로 돌아가 프로세스의 동작을 계속 진행한다.


커널은 프로세스가 요청한 내용을 처리하기 전에 프로세스의 요구가 유효한지 확인한다.
요구 사항이 맞지 않는다면 커널은 시스템 콜을 실패했다고 처리한다.
(예를 들어 시스템의 메모리 용량 이상의 메모리를 요구하는 것 등)

### 시스템 콜 호출의 동작 순서
```c

$ cc -o hello hello.c
$ cc -o hello hello.py

/* 
cc 시스템 콜 로그를 출력하는 커맨드
-o strace 출력을 별도로 저장하기 위한 output 옵션
*/

```

어플리케이션 코드 작성을 위한 프로그램 언어가 무엇이든 상관없이 프로그램이 커널에 요청을 할 때 사용되는 시스템 콜을 호출하는 코드는 동일하다는 것을 알 수 있다.

프로세스가 사용자 모드와 커널 모드 중 어느 쪽에서 실행되고 있는 지의 비율은 'sar' 명령어로 확인할 수 있다.

```

$ sar -P ALL 1 //각 CPU 코어가 어떤 종류의 처리를 실행하고 있는 지를 1초 단위로 측정한다.

```

### 시스템 콜 명령어

- getppid() : 부모 프로세스의 프로세스 ID를 얻는 명령어 (get parent process id)
- kill `process id`: 프로세스를 종료
- strace -T : 각종 시스템 콜 처리에 걸린 시간을 마이크로초 단위로 정밀하게 측정할 수 있다.

## 시스템 콜의 Wrapper 함수 = 시스템 콜을 호출하는 일만 하는 함수

리눅스에는 프로그램의 작성을 도와주기 위해 프로세스 대부분에 필요한 여러 라이브러리 함수가 있다.
시스템 콜은 보통의 함수 호출과는 다르게 C언어 등의 고급언어에서는 직접 호출이 불가능하다.
아키텍처에 의존하는 어셈블리 코드를 사용해 호출할 필요가 있다.

이러한 문제를 해결하기 위해서 OS는 내부적으로 시스템 콜을 호출하는 일만 하는 함수를 제공하는 데 이를 시스템 콜 wrapper라고 한다.

## 표준 C 라이브러리

C 언어에는 ISO에 의해 정해진 표준 라이브러리가 있다.
리눅스에도 이 표준 C라이브러리가 제공되고 있다.
보통은 GNU 프로젝트가 제공하는 glibc를 표준 C라이브러리로 사용한다.
대부분의 C 프로그램은 glibc를 링크하고 있다.

glibc는 시스템 콜의 wrapper 함수를 포함한다.
또한 POSIX 규격에 의해 정의된 함수도 제공한다.

POSIX: 유닉스 계열의 OS가 갖추어야 할 각종 기능을 정해둔 규격
GNU 프로젝트: 유닉스와 호환되는 자유 소프트웨어를 개발하는 프로젝트
  - 프로그램을 어떠한 목적으로도 시행할 수 있는 자유
  - 프로그램이 어떻게 동작하는지 학습하고 자신의 필요에 맞게 개박할 수 있는 자유, 이를 위해서는 소스코드에 대한 접근이 전제되어야 한다.
  - 이웃을 돕도록 복제물을 재배포할 수 있는 자유
  - 프로그램을 개선할 수 있는 자유와 개선된 이점을 공동체 전체가 누리도록 발표할 수 있는 자유, 이를 위해서도 역시 소스코드에 대한 접근이 전제되어야 한다.
ISO: 국제 표준화 기구

```

$ ldd /bin/echo

ldd: 프로그램이 어떠한 라이브러리를 링크하고 있는 지 알 수 있는 명령어

```

## OS가 제공하는 프로그램

OS가 제공하는 프로그램은 OS가 제공하는 라이브러리와 마찬가지로 대부분의 프로그램이 필요하다
OS의 동작을 변경시키는 프로그램도 OS의 일부로써 제공된다.

- 시스템 초기화: init
- OS의 동작을 바꿈: sysctl, nice, sync
- 파일 관련: touch, mkdir
- 텍스트 데이터 가공: grep, sort, uniq
- 성능 측정: sar, iostat
- 컴파일러: gcc
- 스크립트 언어 실행 환경: perl, python, ruby
- 셀: bash
- 윈도우 시스템: X

